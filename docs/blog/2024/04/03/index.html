<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Guorui Zhong">
<title>Guorui Zhong - A comprehensive single-cell map of T cell exhaustion-associated immune environments in human breast cancer</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #212529;
      }
</style>
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Guorui Zhong</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../index.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../crispr/index.html" rel="" target="">
 <span class="menu-text">CRISPR</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../keyboard/index.html" rel="" target="">
 <span class="menu-text">Keyboard</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../python/index.html" rel="" target="">
 <span class="menu-text">Python</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../r/index.html" rel="" target="">
 <span class="menu-text">R</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com/citations?user=g0MfTPMAAAAJ&amp;hl=en" rel="" target=""><i class="bi bi-journal-check" role="img" aria-label="journal-check">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/guorui-zhong-754761185/" rel="" target=""><i class="bi bi-linkedin" role="img" aria-label="linkedin">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/guoruizhong" rel="" target=""><i class="bi bi-github" role="img" aria-label="github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">A comprehensive single-cell map of T cell exhaustion-associated immune environments in human breast cancer</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">scrna</div>
                <div class="quarto-category">paper</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://guoruizhong.github.io/">Guorui Zhong</a> <a href="https://orcid.org/0000-0002-1955-2847" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Wednesday, April 3, 2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">Monday, April 29, 2024</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#load-libraries-and-data-setup" id="toc-load-libraries-and-data-setup" class="nav-link active" data-scroll-target="#load-libraries-and-data-setup">Load libraries and data setup</a></li>
  <li>
<a href="#preprocess-scrnaseq-data" id="toc-preprocess-scrnaseq-data" class="nav-link" data-scroll-target="#preprocess-scrnaseq-data">Preprocess scRNAseq Data</a>
  <ul class="collapse">
<li><a href="#save-raw-data" id="toc-save-raw-data" class="nav-link" data-scroll-target="#save-raw-data">Save raw Data</a></li>
  <li><a href="#aggregate-samples-data" id="toc-aggregate-samples-data" class="nav-link" data-scroll-target="#aggregate-samples-data">Aggregate samples data</a></li>
  <li><a href="#inspect-the-quality-metrics" id="toc-inspect-the-quality-metrics" class="nav-link" data-scroll-target="#inspect-the-quality-metrics">Inspect the quality metrics</a></li>
  <li><a href="#run-general-workflow" id="toc-run-general-workflow" class="nav-link" data-scroll-target="#run-general-workflow">Run general workflow</a></li>
  <li><a href="#finding-deg-for-clusters" id="toc-finding-deg-for-clusters" class="nav-link" data-scroll-target="#finding-deg-for-clusters">Finding DEG for clusters</a></li>
  <li><a href="#annotate-cell-types" id="toc-annotate-cell-types" class="nav-link" data-scroll-target="#annotate-cell-types">Annotate cell types</a></li>
  <li><a href="#cell-type-frequencies" id="toc-cell-type-frequencies" class="nav-link" data-scroll-target="#cell-type-frequencies">Cell type frequencies</a></li>
  <li><a href="#cytof-vs-10x-cell-type" id="toc-cytof-vs-10x-cell-type" class="nav-link" data-scroll-target="#cytof-vs-10x-cell-type">Cytof vs 10x Cell type</a></li>
  <li><a href="#inspect-some-chemokine-features" id="toc-inspect-some-chemokine-features" class="nav-link" data-scroll-target="#inspect-some-chemokine-features">Inspect some chemokine features</a></li>
  <li><a href="#chemkine-expression-per-cell-type" id="toc-chemkine-expression-per-cell-type" class="nav-link" data-scroll-target="#chemkine-expression-per-cell-type">Chemkine expression per cell type</a></li>
  <li><a href="#save-immune-subsets" id="toc-save-immune-subsets" class="nav-link" data-scroll-target="#save-immune-subsets">Save immune subsets</a></li>
  </ul>
</li>
  <li>
<a href="#t-cells-subclustering" id="toc-t-cells-subclustering" class="nav-link" data-scroll-target="#t-cells-subclustering">T cells subclustering</a>
  <ul class="collapse">
<li><a href="#process-t-cells-subset" id="toc-process-t-cells-subset" class="nav-link" data-scroll-target="#process-t-cells-subset">Process T cells subset</a></li>
  <li><a href="#cluster-proportions" id="toc-cluster-proportions" class="nav-link" data-scroll-target="#cluster-proportions">Cluster proportions</a></li>
  <li><a href="#finding-cluster-deg" id="toc-finding-cluster-deg" class="nav-link" data-scroll-target="#finding-cluster-deg">Finding cluster DEG</a></li>
  <li><a href="#correlation-matrix" id="toc-correlation-matrix" class="nav-link" data-scroll-target="#correlation-matrix">Correlation matrix</a></li>
  <li><a href="#cd4cd8-ratio" id="toc-cd4cd8-ratio" class="nav-link" data-scroll-target="#cd4cd8-ratio">CD4/CD8 ratio</a></li>
  </ul>
</li>
  <li><a href="#t-cells-edger-pseudobulk" id="toc-t-cells-edger-pseudobulk" class="nav-link" data-scroll-target="#t-cells-edger-pseudobulk">T cells EdgeR pseudobulk</a></li>
  <li>
<a href="#figure1" id="toc-figure1" class="nav-link" data-scroll-target="#figure1">Figure1</a>
  <ul class="collapse">
<li><a href="#umap-plots" id="toc-umap-plots" class="nav-link" data-scroll-target="#umap-plots">UMAP plots</a></li>
  <li><a href="#highlight-fibroblast" id="toc-highlight-fibroblast" class="nav-link" data-scroll-target="#highlight-fibroblast">Highlight fibroblast</a></li>
  <li><a href="#feature-plots" id="toc-feature-plots" class="nav-link" data-scroll-target="#feature-plots">Feature plots</a></li>
  <li><a href="#dotplots-for-lineage-markers" id="toc-dotplots-for-lineage-markers" class="nav-link" data-scroll-target="#dotplots-for-lineage-markers">Dotplots for lineage markers</a></li>
  <li><a href="#gene-expression-heatmap" id="toc-gene-expression-heatmap" class="nav-link" data-scroll-target="#gene-expression-heatmap">Gene expression heatmap</a></li>
  <li><a href="#cell-type-frequence" id="toc-cell-type-frequence" class="nav-link" data-scroll-target="#cell-type-frequence">Cell type frequence</a></li>
  <li><a href="#cytof-vs-10x" id="toc-cytof-vs-10x" class="nav-link" data-scroll-target="#cytof-vs-10x">Cytof vs 10x</a></li>
  <li><a href="#cell-numbers-before-and-after-filtering" id="toc-cell-numbers-before-and-after-filtering" class="nav-link" data-scroll-target="#cell-numbers-before-and-after-filtering">Cell numbers before and after filtering</a></li>
  <li><a href="#clinical-information" id="toc-clinical-information" class="nav-link" data-scroll-target="#clinical-information">Clinical information</a></li>
  </ul>
</li>
  <li>
<a href="#figure2" id="toc-figure2" class="nav-link" data-scroll-target="#figure2">Figure2</a>
  <ul class="collapse">
<li><a href="#ie1-vs-ie2-volcano-plot" id="toc-ie1-vs-ie2-volcano-plot" class="nav-link" data-scroll-target="#ie1-vs-ie2-volcano-plot">IE1 vs IE2 Volcano Plot</a></li>
  <li><a href="#ie1-vs-ie2-boxplot" id="toc-ie1-vs-ie2-boxplot" class="nav-link" data-scroll-target="#ie1-vs-ie2-boxplot">IE1 vs IE2 BoxPlot</a></li>
  </ul>
</li>
  <li><a href="#sessioninfo" id="toc-sessioninfo" class="nav-link" data-scroll-target="#sessioninfo">SessionInfo</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><section id="load-libraries-and-data-setup" class="level2"><h2 class="anchored" data-anchor-id="load-libraries-and-data-setup">Load libraries and data setup</h2>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Install and Load required packages</span></span>
<span><span class="co"># if (!any(rownames(installed.packages()) == "DoubletFinder")){</span></span>
<span><span class="co">#   remotes::install_github('chris-mcginnis-ucsf/DoubletFinder')</span></span>
<span><span class="co"># }</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/">ggpubr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/rstatix/">rstatix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">DoubletFinder</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lazappi/clustree">clustree</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/taiyun/corrplot">corrplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap">ComplexHeatmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/circlize">circlize</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/">ggrepel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bioinf.wehi.edu.au/edgeR/">edgeR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>future.globals.maxSize <span class="op">=</span> <span class="fl">8e9</span><span class="op">)</span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="preprocess-scrnaseq-data" class="level2"><h2 class="anchored" data-anchor-id="preprocess-scrnaseq-data">Preprocess scRNAseq Data</h2>
<section id="save-raw-data" class="level3"><h3 class="anchored" data-anchor-id="save-raw-data">Save raw Data</h3>
<p><a href="raw_matrix.png"></a></p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Project directory</span></span>
<span><span class="va">project_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Directory for scRNA data</span></span>
<span><span class="va">input_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">project_dir</span>, <span class="st">"BCexh_scRNAseq/data"</span><span class="op">)</span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Get a list of sample names for creating seurat object from clinical info</span></span>
<span><span class="va">sample_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">project_dir</span>, <span class="st">"supp_data"</span>, <span class="st">"Supplementary Data1.xlsx"</span><span class="op">)</span>,</span>
<span>    <span class="co">### start from row3</span></span>
<span>    skip <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="st">"Patient ID"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="op">~</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"T{.x}"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### load data to a list</span></span>
<span><span class="va">obj_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sample</span> <span class="kw">in</span> <span class="va">sample_list</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="co">### Read counts matrix</span></span>
<span>    <span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">input_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">sample</span>, <span class="st">"_singlecell_count_matrix.txt"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        sep <span class="op">=</span> <span class="st">"\t"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Create seurat object</span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span></span>
<span>        counts <span class="op">=</span> <span class="va">counts</span>,</span>
<span>        min.cells <span class="op">=</span> <span class="fl">5</span>, min.features <span class="op">=</span> <span class="fl">200</span>, project <span class="op">=</span> <span class="va">sample</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Retrieve cell barcodes after filtering</span></span>
<span>    <span class="va">cell_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Read metadata with annotation</span></span>
<span>    <span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">input_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">sample</span>, <span class="st">"_complete_singlecell_metadata.txt"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        sep <span class="op">=</span> <span class="st">"\t"</span>,</span>
<span>        header <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Align the cell barcode</span></span>
<span>    <span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">metadata</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_delim</a></span><span class="op">(</span></span>
<span>            <span class="va">cellID</span>, delim <span class="op">=</span> <span class="st">"_"</span>, names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample_id"</span>, <span class="st">"cell_barcode"</span><span class="op">)</span>,</span>
<span>            cols_remove <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>        <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cell_barcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">cell_barcode</span>, <span class="st">".1"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">column_to_rownames</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"cell_barcode"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample_id</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">metadata</span><span class="op">[</span><span class="va">cell_ids</span>, <span class="op">]</span></span>
<span></span>
<span>    <span class="va">metadata</span><span class="op">$</span><span class="va">nCount_RNA</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">nCount_RNA</span></span>
<span>    <span class="va">metadata</span><span class="op">$</span><span class="va">nFeature_RNA</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">nFeature_RNA</span></span>
<span></span>
<span>    <span class="co"># all(rownames(metadata) == colnames(obj))</span></span>
<span></span>
<span>    <span class="co">### Assign metadata with new cell barcode</span></span>
<span>    <span class="co"># obj &lt;- AddMetaData(object = obj, metadata = metadata)</span></span>
<span></span>
<span>    <span class="va">obj</span><span class="op">@</span><span class="va">meta.data</span> <span class="op">&lt;-</span> <span class="va">metadata</span></span>
<span></span>
<span>    <span class="co">### Save new obj</span></span>
<span>    <span class="va">obj_list</span><span class="op">[[</span><span class="va">sample</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obj</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### There are 4,.75 GB</span></span>
<span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html">obj_size</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Look at the cells and genes for each sample</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">obj_list</span>, <span class="va">dim</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save data for later exploration</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html">dir_create</a></span><span class="op">(</span><span class="va">output_path</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sample</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="va">obj_list</span><span class="op">[[</span><span class="va">sample</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co">### Calculate mitotic/ribosomal percentage</span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html">PercentageFeatureSet</a></span><span class="op">(</span></span>
<span>        <span class="va">obj</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span>, col.name <span class="op">=</span> <span class="st">"percent_mito"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html">PercentageFeatureSet</a></span><span class="op">(</span></span>
<span>        <span class="va">obj</span>, pattern <span class="op">=</span> <span class="st">"^RP[LS]"</span>, col.name <span class="op">=</span> <span class="st">"percent_ribo"</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">### Save </span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>        <span class="va">obj</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">sample</span>, <span class="st">".rds"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>        compress <span class="op">=</span> <span class="st">"xz"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load data</span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># obj_list$TBB011[[]] |&gt; head()</span></span>
<span></span>
<span><span class="co">### Inspect PCA</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sample</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="va">sample</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ElbowPlot.html">ElbowPlot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">obj_list</span><span class="op">[[</span><span class="va">sample</span><span class="op">]</span><span class="op">]</span>, ndim <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="va">sample</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">FontSize</a></span><span class="op">(</span>x.text <span class="op">=</span> <span class="fl">8</span>, y.text <span class="op">=</span> <span class="fl">8</span>, x.title <span class="op">=</span> <span class="fl">8</span>, y.title <span class="op">=</span> <span class="fl">8</span>, main <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">plots</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DimHeatmap(obj_list$TBB102, dims = 10:30, cells = 500, balanced = TRUE)</span></span>
<span><span class="co"># FeaturePlot(obj_list$TBB102, reduction = "tsne", features = "nFeature_RNA")</span></span>
<span><span class="co"># DimPlot(obj_list$TBB102, label = TRUE, group.by = "RNA_snn_res.0.4")</span></span>
<span><span class="co"># DimPlot(obj_list$TBB102, label = TRUE, reduction = "tsne")</span></span>
<span></span>
<span><span class="co"># obj_list$TBB011[[]] |&gt; head()</span></span>
<span></span>
<span><span class="co">### Glimpse QC metrics</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>,</span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nFeature_RNA"</span>, <span class="st">"nCount_RNA"</span>, <span class="st">"percent_mito"</span><span class="op">)</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">1</span>, pt.size <span class="op">=</span> <span class="fl">0</span>, sort <span class="op">=</span> <span class="cn">FALSE</span>, log <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Cell type</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span></span>
<span>    <span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, ncol <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"PTPRC"</span>, <span class="st">"EPCAM"</span>, <span class="st">"PECAM1"</span>, <span class="st">"FAP"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Varify DoubletFinder</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span><span class="op">$</span><span class="va">excl_doublet</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">UMAPPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, group.by <span class="op">=</span> <span class="st">"excl_doublet"</span>,</span>
<span>    <span class="co"># order = c(TRUE, FALSE),</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>  <span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">excl_doublet</span>, </span>
<span>  <span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">RNA_snn_res.0.4</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">### Sanity checks</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, label <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DotPlot.html">DotPlot</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"PTPRC"</span>, <span class="st">"EPCAM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"PTPRC"</span>, <span class="st">"EPCAM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FAP"</span>, <span class="st">"PECAM1"</span>, <span class="st">"PTPRC"</span>, <span class="st">"EPCAM"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD14"</span>, <span class="st">"CD3E"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">$</span><span class="va">TBB011</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MKI67"</span><span class="op">)</span>, split.by <span class="op">=</span> <span class="st">"excl_doublet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="aggregate-samples-data" class="level3"><h3 class="anchored" data-anchor-id="aggregate-samples-data">Aggregate samples data</h3>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Clear environment</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Output directory</span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Samples to load</span></span>
<span><span class="va">sample_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="co">### IE1 </span></span>
<span>        <span class="st">"TBB011"</span>,</span>
<span>        <span class="st">"TBB111"</span>,</span>
<span>        <span class="st">"TBB129"</span>,</span>
<span>        <span class="st">"TBB165"</span>,</span>
<span>        <span class="st">"TBB171"</span>,</span>
<span>        <span class="st">"TBB184"</span>,</span>
<span>        <span class="st">"TBB338"</span>,</span>
<span>    </span>
<span>    <span class="co">### IE2</span></span>
<span>        <span class="st">"TBB035"</span>,</span>
<span>        <span class="st">"TBB075"</span>,</span>
<span>        <span class="st">"TBB102"</span>,</span>
<span>        <span class="st">"TBB212"</span>,</span>
<span>        <span class="st">"TBB214"</span>,</span>
<span>        <span class="st">"TBB226"</span>,</span>
<span>        <span class="st">"TBB330"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">### Load IE1 vs IE2 samples for easier processing</span></span>
<span><span class="va">obj_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">sample</span> <span class="kw">in</span> <span class="va">sample_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">### Load data</span></span>
<span>    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">sample</span>, <span class="st">".rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">obj_list</span><span class="op">[[</span><span class="va">sample</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">obj</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### Merge objects</span></span>
<span><span class="va">merged_pre_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">obj_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">obj_list</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, add.cell.ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">obj_list</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">### 4.75GB</span></span>
<span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html">obj_size</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Remove for efficient memory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">obj_list</span>, <span class="va">obj</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Need to Join layers in Seurat V5</span></span>
<span><span class="va">merged_pre_filter</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/SplitLayers.html">JoinLayers</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Excluding high-confidence doublets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">$</span><span class="va">sample</span>, <span class="va">merged_pre_filter</span><span class="op">$</span><span class="va">excl_doublet</span><span class="op">)</span></span>
<span><span class="va">merged_pre_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">merged_pre_filter</span>, subset <span class="op">=</span> <span class="va">excl_doublet</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save cell count data for each sample</span></span>
<span><span class="va">cells_per_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">cells_per_sample</span>, </span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"CellsPerSample_preFilter.csv"</span><span class="op">)</span>,</span>
<span>    row.names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### 4.26 GB</span></span>
<span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html">obj_size</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="inspect-the-quality-metrics" class="level3"><h3 class="anchored" data-anchor-id="inspect-the-quality-metrics">Inspect the quality metrics</h3>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load data</span></span>
<span><span class="va">merged_pre_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"merged_pre_filter.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Vlnplot</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_pre_filter</span>, </span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nFeature_RNA"</span>, <span class="st">"nCount_RNA"</span>, <span class="st">"percent_mito"</span><span class="op">)</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">1</span>, pt.size <span class="op">=</span> <span class="fl">0</span>, sort <span class="op">=</span> <span class="cn">FALSE</span>, log <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Density plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">percent_mito</span><span class="op">)</span>, </span>
<span>    main <span class="op">=</span> <span class="st">"Mitochondrial Percentage Density Plot"</span>, </span>
<span>    xlab <span class="op">=</span> <span class="st">"Percent Mitochondrial Genes"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">nCount_RNA</span><span class="op">)</span>, </span>
<span>    main <span class="op">=</span> <span class="st">"Total Reads"</span>, </span>
<span>    xlab <span class="op">=</span> <span class="st">"Total Reads per Cell"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/density.html">density</a></span><span class="op">(</span><span class="va">merged_pre_filter</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">nFeature_RNA</span><span class="op">)</span>, </span>
<span>    main <span class="op">=</span> <span class="st">"Number of detected genes"</span>, </span>
<span>    xlab <span class="op">=</span> <span class="st">"Deteced Genes per cell"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Filtering low quality cells</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_pre_filter</span>,</span>
<span>    subset <span class="op">=</span> <span class="va">nFeature_RNA</span> <span class="op">&gt;</span> <span class="fl">200</span> <span class="op">&amp;</span></span>
<span>        <span class="va">nFeature_RNA</span> <span class="op">&lt;</span> <span class="fl">7500</span> <span class="op">&amp;</span></span>
<span>        <span class="va">percent_mito</span> <span class="op">&lt;</span> <span class="fl">20</span> <span class="op">&amp;</span></span>
<span>        <span class="va">nCount_RNA</span> <span class="op">&lt;</span> <span class="fl">75000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save cell count data for each sample post filtering</span></span>
<span><span class="va">cells_per_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">cells_per_sample</span>, </span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"CellsPerSample_postFilter.csv"</span><span class="op">)</span>,</span>
<span>    row.names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save mean reads and median gene counts per cell for each sample</span></span>
<span><span class="va">mean_reads</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample"</span>, <span class="st">"nCount_RNA"</span>, <span class="st">"nFeature_RNA"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">sample</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    mean_reads <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">nCount_RNA</span><span class="op">)</span>, </span>
<span>    median_genes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">nFeature_RNA</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">mean_reads</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"postfilter_stats.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"merged_post_filter.rds"</span><span class="op">)</span>, </span>
<span>    compress <span class="op">=</span> <span class="st">"xz"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="run-general-workflow" class="level3"><h3 class="anchored" data-anchor-id="run-general-workflow">Run general workflow</h3>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Maxmize memory usage</span></span>
<span><span class="co"># future::plan("multiprocess", workers = 2)</span></span>
<span><span class="co"># options(future.globals.maxSize = 5* 1000 * 1024^2)</span></span>
<span></span>
<span><span class="co">### Load data</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"merged_post_filter.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Option: Apply sctransform normalization: replaces FindVariableFeatures,</span></span>
<span><span class="co">### Normalize and ScaleData. For a start, don't regress out anything</span></span>
<span><span class="co">### Note! This step comsumes a lot memory</span></span>
<span><span class="co"># merged_post_filter &lt;- SCTransform(merged_post_filter, verbose = TRUE)</span></span>
<span></span>
<span><span class="co">### Standard normalization</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>,</span>
<span>    x.low.cutoff <span class="op">=</span> <span class="fl">0.0125</span>, y.cutoff <span class="op">=</span> <span class="fl">0.25</span>, do.plot <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>,</span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/VariableFeatures.html">VariableFeatures</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Find the resolution: Clustree analysis</span></span>
<span><span class="co"># clustree(merged_post_filter, prefix = "RNA_snn_res.", exprs = "scale.data")</span></span>
<span></span>
<span><span class="co">### Graph-based clustering</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">27</span><span class="op">)</span> </span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, resolution <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">27</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### If the clusters are not ordered correctly:</span></span>
<span><span class="co"># cluster_order &lt;- c(0:57)</span></span>
<span><span class="co"># merged_post_filter@active.ident &lt;- factor(x = merged_post_filter@active.ident, levels = cluster_order)</span></span>
<span></span>
<span><span class="co">### Save object to easily load it back without re-running computationally</span></span>
<span><span class="co">### intensive steps above</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>,</span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"merged_complete_umap.rds"</span><span class="op">)</span>,</span>
<span>    compress <span class="op">=</span> <span class="st">"xz"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load processed data from output directory</span></span>
<span><span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output"</span><span class="op">)</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"merged_complete_umap.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Examine and visualize PCA results in a few different ways</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">merged_post_filter</span><span class="op">[[</span><span class="st">"pca"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, nfeatures <span class="op">=</span> <span class="fl">5</span>, projected <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### For easy exploration of the primary sources of heterogeneity in a dataset</span></span>
<span><span class="co"># DimHeatmap(merged_post_filter, dims = 1:6, cells = 500, balanced = TRUE)</span></span>
<span><span class="co"># VizDimLoadings(merged_post_filter, dims = 1:2)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/ElbowPlot.html">ElbowPlot</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, ndim <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Inspect cluster</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"cell_type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Check some marker expression</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>,</span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PECAM1"</span>, <span class="st">"EPCAM"</span>, <span class="st">"FAP"</span>, <span class="st">"PTPRC"</span>, <span class="st">"CD3E"</span>, <span class="st">"CD14"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save number of clusters and cells per cluster post filtering</span></span>
<span><span class="va">cells_per_cluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">SCT_snn_res.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">cells_per_cluster</span>, </span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">outpath</span>, <span class="st">"dim27_res2_CellsPerCluster.csv"</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save cluster proportions by sample</span></span>
<span><span class="va">cluster_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span>, <span class="va">merged_post_filter</span><span class="op">$</span><span class="va">sample</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">cluster_sample</span>, </span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"cellnr_per_cluster_bySample.csv"</span><span class="op">)</span>, </span>
<span>    row.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cluster_sample_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span>, <span class="va">merged_post_filter</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>, </span>
<span>    margin <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">cluster_sample_prop</span>, </span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"cluster_samples_proportions.csv"</span><span class="op">)</span>, </span>
<span>    row.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="finding-deg-for-clusters" class="level3"><h3 class="anchored" data-anchor-id="finding-deg-for-clusters">Finding DEG for clusters</h3>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">merged_post_filter</span><span class="op">$</span><span class="va">seurat_clusters</span></span>
<span><span class="va">cluster_markers_mast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html">FindAllMarkers</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>,</span>
<span>    test.use <span class="op">=</span> <span class="st">"MAST"</span>,</span>
<span>    only.pos <span class="op">=</span> <span class="cn">TRUE</span>, min.pct <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>    logfc.threshold <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">cluster_markers_mast</span>,</span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"DE_cluster_AllMarkerGenes_MAST.csv"</span><span class="op">)</span>,</span>
<span>    row.names <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Top10 DEG for each cluster</span></span>
<span><span class="va">marker_genes</span> <span class="op">&lt;-</span> <span class="va">cluster_markers_mast</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">avg_log2FC</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">marker_genes</span>,</span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"DE_cluster_MarkerGenesTop10.csv"</span><span class="op">)</span>,</span>
<span>    row.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="annotate-cell-types" class="level3"><h3 class="anchored" data-anchor-id="annotate-cell-types">Annotate cell types</h3>
</section><section id="cell-type-frequencies" class="level3"><h3 class="anchored" data-anchor-id="cell-type-frequencies">Cell type frequencies</h3>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load processed scRNA data</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"merged_complete_umap.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Extract group info</span></span>
<span><span class="va">sample_info</span> <span class="op">&lt;-</span> <span class="va">merged_post_filter</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">IE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Assign pDC or cDC to dendritic cell</span></span>
<span><span class="co"># merged_post_filter$cell_type[merged_post_filter$cell_type == "pDC"] &lt;- "dendritic cell"</span></span>
<span></span>
<span><span class="co">### Reset active IDs to cell type</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"cell_type"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save cell number of cell type</span></span>
<span><span class="va">celltype_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span><span class="op">$</span><span class="va">cell_type</span>, <span class="va">merged_post_filter</span><span class="op">$</span><span class="va">sample</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">celltype_sample</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"celltype_samples.csv"</span><span class="op">)</span>,</span>
<span>    row.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save proportions of cell type for each sample</span></span>
<span><span class="va">celltype_sample_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">$</span><span class="va">cell_type</span>, <span class="va">merged_post_filter</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>,</span>
<span>    margin <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="va">celltype_sample_prop</span>,</span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"celltype_samples_proportions.csv"</span><span class="op">)</span>,</span>
<span>    row.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Ploty cell type frequencies using stacked barplot</span></span>
<span><span class="va">celltype_sample_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"celltype_samples_proportions.csv"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"TB"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"sample"</span>, values_to <span class="op">=</span> <span class="st">"percentage"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cell_type <span class="op">=</span> <span class="va">X</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co">### Factor cell type</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        cell_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>            <span class="va">cell_type</span>,</span>
<span>            levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                <span class="st">"T/NK cell"</span>, <span class="st">"myeloid"</span>, <span class="st">"B cell"</span>, <span class="st">"granulocyte"</span>,</span>
<span>                <span class="st">"dendritic cell"</span>, <span class="co"># "cDC", "pDC",</span></span>
<span>                <span class="st">"plasma cell"</span>, <span class="st">"epithelial"</span>, <span class="st">"fibroblast"</span>, <span class="st">"endothelial"</span></span>
<span>            <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">sample_info</span>, by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Plot</span></span>
<span><span class="va">celltype_sample_prop</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sample</span>, y <span class="op">=</span> <span class="va">percentage</span>, fill <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sample composition by cell type"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Cell type proportions by IE1 vs IE2</span></span>
<span><span class="va">stat_res</span> <span class="op">&lt;-</span> <span class="va">celltype_sample_prop</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cell_type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rpkgs.datanovia.com/rstatix/reference/wilcox_test.html">wilcox_test</a></span><span class="op">(</span><span class="va">percentage</span> <span class="op">~</span> <span class="va">IE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rpkgs.datanovia.com/rstatix/reference/add_significance.html">add_significance</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rpkgs.datanovia.com/rstatix/reference/get_pvalue_position.html">add_xy_position</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"cell_type"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_sample_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">IE</span>, y <span class="op">=</span> <span class="va">percentage</span>, fill <span class="op">=</span> <span class="va">IE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">cell_type</span>, scales <span class="op">=</span> <span class="st">"free"</span>, ncol <span class="op">=</span> <span class="fl">5</span>, strip.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># theme(panel.background = element_blank())+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"proportion"</span><span class="op">)</span></span>
<span>    <span class="co"># stat_pvalue_manual(stat_res, hide.ns = TRUE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="cytof-vs-10x-cell-type" class="level3"><h3 class="anchored" data-anchor-id="cytof-vs-10x-cell-type">Cytof vs 10x Cell type</h3>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Cytof cell type percentages</span></span>
<span><span class="va">cytof_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/03_Additional_files"</span><span class="op">)</span></span>
<span><span class="va">cytof_perc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">cytof_dir</span>, <span class="st">"cytof_celltype_prop.csv"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"TBB"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"sample"</span>, values_to <span class="op">=</span> <span class="st">"percentage"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cell_type <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">sample_info</span>, by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"cytof"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cytof_perc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">sample</span>, y <span class="op">=</span> <span class="va">percentage</span>, fill <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"CyTOF percentages"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Adapt 10x celltypes to fit CyTOF celltypes</span></span>
<span><span class="co"># merged_post_filter$cell_type &lt;- factor(</span></span>
<span><span class="co">#     merged_post_filter$cell_type,</span></span>
<span><span class="co">#     levels = c(</span></span>
<span><span class="co">#         "T/NK cell",</span></span>
<span><span class="co">#         "myeloid",</span></span>
<span><span class="co">#         "B cell",</span></span>
<span><span class="co">#         "dendritic cell",</span></span>
<span><span class="co">#         "granulocyte",</span></span>
<span><span class="co">#         "plasma cell",</span></span>
<span><span class="co">#         "epithelial",</span></span>
<span><span class="co">#         "endothelial",</span></span>
<span><span class="co">#         "fibroblast"</span></span>
<span><span class="co">#         # "cDC",</span></span>
<span><span class="co">#         # "pDC"</span></span>
<span><span class="co">#     )</span></span>
<span><span class="co"># )</span></span>
<span><span class="va">celltype_sample_prop</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">sample</span>, y <span class="op">=</span> <span class="va">percentage</span>, fill <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"10x percentages"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Combine cytof and 10x percentages</span></span>
<span><span class="va">celltype_pct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">cytof_perc</span>,</span>
<span>    <span class="va">celltype_sample_prop</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"10x"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">celltype_pct</span><span class="op">$</span><span class="va">cell_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>    <span class="va">celltype_pct</span><span class="op">$</span><span class="va">cell_type</span>,</span>
<span>    levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"T/NK cell"</span>, <span class="st">"myeloid"</span>, <span class="st">"B cell"</span>, <span class="st">"dendritic cell"</span>, <span class="st">"granulocyte"</span>,</span>
<span>        <span class="st">"plasma cell"</span>, <span class="st">"epithelial"</span>, <span class="st">"endothelial"</span>, <span class="st">"fibroblast"</span>, <span class="st">"other"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">celltype_pct</span><span class="op">$</span><span class="va">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">celltype_pct</span><span class="op">$</span><span class="va">method</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cytof"</span>, <span class="st">"10x"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">celltype_pct</span> <span class="op">&lt;-</span> <span class="va">celltype_pct</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_pct</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">method</span>, y <span class="op">=</span> <span class="va">percentage</span>, fill <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sample</span>, ncol <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Celltype percentages: CyTOF vs. scRNA-seq'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="inspect-some-chemokine-features" class="level3"><h3 class="anchored" data-anchor-id="inspect-some-chemokine-features">Inspect some chemokine features</h3>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">CCLs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"CCL"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">28</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">CX_XCs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"CXCL"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">17</span><span class="op">)</span><span class="op">)</span>, <span class="st">"CXCL4L1"</span>, <span class="st">"XCL1"</span>, <span class="st">"XCL2"</span>, <span class="st">"CX3CL1"</span><span class="op">)</span></span>
<span><span class="va">ILs</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"IL"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">33</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">other_cytokines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"TNF"</span>, <span class="st">"IFNG"</span>, <span class="st">"IFNA1"</span>, <span class="st">"IFNB1"</span>, <span class="st">"TGFB1"</span>, <span class="st">"CSF1"</span>, <span class="st">"CSF2"</span>, <span class="st">"CSF3"</span>, <span class="st">"EPO"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">interaction_other</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"CD47"</span>, <span class="st">"SIRPG"</span>, <span class="st">"SIRPA"</span>, <span class="st">"FASLG"</span>, <span class="st">"FAS"</span>, <span class="st">"CD80"</span>, <span class="st">"CD86"</span>, <span class="st">"CTLA4"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cytokine_receptor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CCR1'</span>, <span class="st">'CCR2'</span>, <span class="st">'CCR3'</span>, <span class="st">'CCR4'</span>, <span class="st">'CCR5'</span>, <span class="st">'CCR6'</span>, <span class="st">'CCR7'</span>, <span class="st">'CCR8'</span>, <span class="st">'CCR9'</span>, </span>
<span>    <span class="st">'CCR10'</span>, <span class="st">'CCR11'</span>, <span class="st">'IL10RA'</span>, <span class="st">'IL4R'</span>, <span class="st">'CXCR1'</span>, <span class="st">'CXCR2'</span>, <span class="st">'CXCR3'</span>, <span class="st">'CXCR4'</span>, </span>
<span>    <span class="st">'CXCR5'</span>, <span class="st">'CXCR6'</span>, <span class="st">'CXCR7'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># example_data &lt;- readRDS(here(output_path, ""))</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nFeature_RNA"</span><span class="op">)</span>, pt.size <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># theme(legend.position = "right") +</span></span>
<span><span class="co"># guides(fill = guide_legend(ncol = 2))</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DotPlot.html">DotPlot</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PTPRC"</span>, <span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"CD68"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nFeature_RNA"</span>, <span class="st">"nCount_RNA"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="chemkine-expression-per-cell-type" class="level3"><h3 class="anchored" data-anchor-id="chemkine-expression-per-cell-type">Chemkine expression per cell type</h3>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">chemokines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"CXCL9"</span>, <span class="st">"CXCL10"</span>, <span class="st">"CXCL13"</span>, <span class="st">"CCL4"</span>, <span class="st">"CCL5"</span>, <span class="st">"CCL3"</span>, <span class="st">"CXCL8"</span>,</span>
<span>    <span class="st">"CCL17"</span>, <span class="st">"CCL22"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">chemokine_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>celltype <span class="op">=</span> <span class="va">merged_post_filter</span><span class="op">$</span><span class="va">cell_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Seurat V5, the counts data do not have colnames and rownames</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">merged_post_filter</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">layers</span><span class="op">$</span><span class="va">counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Cells.html">Features</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Cells.html">Cells</a></span><span class="op">(</span><span class="va">merged_post_filter</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">chemokines</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">chemokine_tab</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">counts</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">chemokine_add</span>  <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>celltype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">chemokine_tab</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">chemokines</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">count_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">chemokine_tab</span><span class="op">$</span><span class="va">celltype</span>, <span class="va">chemokine_tab</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">[</span>, <span class="st">"1"</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">count_i</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>    <span class="va">count_i</span><span class="op">$</span><span class="va">celltype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">count_i</span><span class="op">)</span></span>
<span>    <span class="va">chemokine_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">chemokine_add</span>, <span class="va">count_i</span>, by <span class="op">=</span> <span class="st">"celltype"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="save-immune-subsets" class="level3"><h3 class="anchored" data-anchor-id="save-immune-subsets">Save immune subsets</h3>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load data</span></span>
<span><span class="va">merged_post_filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"merged_complete_umap.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Immune subset</span></span>
<span><span class="va">immune</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>,</span>
<span>    idents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"T/NK cell"</span>, </span>
<span>        <span class="st">"myeloid"</span>, </span>
<span>        <span class="st">"B cell"</span>, </span>
<span>        <span class="st">"granulocyte"</span>, </span>
<span>        <span class="co"># "dendritic cell",</span></span>
<span>        <span class="co"># "cDC",</span></span>
<span>        <span class="st">"pDC"</span>, </span>
<span>        <span class="st">"plasma cell"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">immune</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"immune.rds"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">immune</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## T/NK cell subset</span></span>
<span><span class="va">TNK</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="st">"T/NK cell"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>    <span class="va">TNK</span>,</span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"T_NK_cells.rds"</span><span class="op">)</span>,</span>
<span>    compress <span class="op">=</span> <span class="st">"xz"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">TNK</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Myeloid subset (incl. DCs)</span></span>
<span><span class="va">myeloid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"myeloid"</span>, </span>
<span>        <span class="st">"dendritic cell"</span></span>
<span>        <span class="co"># "cDC", </span></span>
<span>        <span class="co"># "pDC"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">myeloid</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"myeloid_inclDC.rds"</span><span class="op">)</span>, compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">myeloid</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### B cell subset</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="st">"B cell"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">B</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"B_cells.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Plasma cell subset</span></span>
<span><span class="va">PC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="st">"plasma cell"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">PC</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"plasma_cells.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">PC</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Granulocyte subset</span></span>
<span><span class="va">gran</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="st">"granulocyte"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">gran</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"granulocytes.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">gran</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### tumor cell subset</span></span>
<span><span class="va">ep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="st">"epithelial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">ep</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"epithelial.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">ep</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### fibroblast subset</span></span>
<span><span class="va">fib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="st">"fibroblast"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">fib</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"fibroblast.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">fib</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### endothelial cell subset</span></span>
<span><span class="va">endo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">merged_post_filter</span>, idents <span class="op">=</span> <span class="st">"endothelial"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">endo</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">output_path</span>, <span class="st">"endothelial.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">endo</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="t-cells-subclustering" class="level2"><h2 class="anchored" data-anchor-id="t-cells-subclustering">T cells subclustering</h2>
<section id="process-t-cells-subset" class="level3"><h3 class="anchored" data-anchor-id="process-t-cells-subset">Process T cells subset</h3>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load T cells subset</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output"</span><span class="op">)</span></span>
<span><span class="va">run1_Tcell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"T_NK_cells.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">### 6,77GB is too big for running</span></span>
<span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html">obj_size</a></span><span class="op">(</span><span class="va">run1_Tcell</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Use subset data example</span></span>
<span><span class="va">Tcell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span></span>
<span>    <span class="va">run1_Tcell</span>, </span>
<span>    subset <span class="op">=</span> <span class="va">sample</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"TBB011"</span>, <span class="st">"TBB165"</span>, <span class="st">"TBB338"</span>, <span class="st">"TBB075"</span>, <span class="st">"TBB330"</span>, <span class="st">"TBB214"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="fu">lobstr</span><span class="fu">::</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html">obj_size</a></span><span class="op">(</span><span class="va">Tcell</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">run1_Tcell</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Store Keratin and MGP percentage in object meta data</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html">PercentageFeatureSet</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcells</span>, pattern <span class="op">=</span> <span class="st">"^KRT"</span>, col.name <span class="op">=</span> <span class="st">"percent_krt"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html">PercentageFeatureSet</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcells</span>, pattern <span class="op">=</span> <span class="st">"MGP"</span>, col.name <span class="op">=</span> <span class="st">"percent_MGP"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Run Normalization, ScaleData, and FindVariableFeatures</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html">SCTransform</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcells</span>,</span>
<span>    vars.to.regress <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"percent_mito"</span>, <span class="st">"percent_krt"</span>, <span class="st">"percent_MGP"</span><span class="op">)</span>,</span>
<span>    verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Dimensional reduction</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">Tcells</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">Tcells</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span><span class="va">Tcells</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span><span class="va">Tcells</span>, resolution <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Save object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcells</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"Tcells.rds"</span><span class="op">)</span>,</span>
<span>    compress <span class="op">=</span> <span class="st">"xz"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load T cells subset</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output"</span><span class="op">)</span></span>
<span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"Tcells.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/ElbowPlot.html">ElbowPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, ndims <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span><span class="co"># VizDimLoadings(Tcell, dims = 1:2)</span></span>
<span><span class="co"># PCAPlot(Tcell)</span></span>
<span><span class="co"># DimHeatmap(Tcell, dims = 15:20, cells = 500, balanced = TRUE)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, label <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Clustree analysis</span></span>
<span><span class="co"># clustree(Tcell, prefix = "SCT_snn_res.") +</span></span>
<span><span class="co">#     scale_edge_color_continuous(low = "black", high = "black")</span></span>
<span></span>
<span><span class="co">### QC plots</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcell</span>,</span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"nFeature_RNA"</span>, <span class="st">"nCount_RNA"</span>, <span class="st">"percent_mito"</span><span class="op">)</span>,</span>
<span>    ncol <span class="op">=</span> <span class="fl">1</span>, pt.size <span class="op">=</span> <span class="fl">0</span>, sort <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcell</span>,</span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"percent_krt"</span>, <span class="st">"percent_MGP"</span><span class="op">)</span>,</span>
<span>    pt.size <span class="op">=</span> <span class="fl">0</span>, sort <span class="op">=</span> <span class="cn">FALSE</span>, ncol <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, group.by <span class="op">=</span> <span class="st">"Tcell_cluster"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, group.by <span class="op">=</span> <span class="st">"Tcell_metacluster"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, group.by <span class="op">=</span> <span class="st">"SCT_snn_res.1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">Tcell</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PDCD1"</span>, <span class="st">"CD4"</span>, <span class="st">"CD8A"</span>, <span class="st">"FOXP3"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/VlnPlot.html">VlnPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"MKI67"</span><span class="op">)</span>, pt.size <span class="op">=</span> <span class="fl">0</span>, sort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Highlight individual clusters</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">Tcell</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">Tcell</span><span class="op">$</span><span class="va">Tcell_metacluster</span></span>
<span><span class="va">cells_CD4ex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/WhichCells.html">WhichCells</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcell</span>, ident <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD4_exhausted"</span>, <span class="st">"CD8_exhausted"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcell</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, cells.highlight <span class="op">=</span> <span class="va">cells_CD4ex</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="cluster-proportions" class="level3"><h3 class="anchored" data-anchor-id="cluster-proportions">Cluster proportions</h3>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load processed data</span></span>
<span><span class="va">Tcell_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq/output/Tcells"</span><span class="op">)</span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/create.html">dir_create</a></span><span class="op">(</span><span class="va">Tcell_dir</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Extract group info</span></span>
<span><span class="va">sample_info</span> <span class="op">&lt;-</span> <span class="va">Tcells</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">IE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Which cluster is each sample made of? (by cluster)</span></span>
<span><span class="va">cluster_samples_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">$</span><span class="va">SCT_snn_res.1</span>, <span class="va">Tcells</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cluster <span class="op">=</span> <span class="va">Var1</span>, sample <span class="op">=</span> <span class="va">Var2</span>, prop <span class="op">=</span> <span class="va">Freq</span><span class="op">)</span></span>
<span><span class="co"># write.csv(</span></span>
<span><span class="co">#     cluster_samples_count,</span></span>
<span><span class="co">#     here(Tcell_dir, "cluster_samples_count.csv"),</span></span>
<span><span class="co">#     row.names = TRUE</span></span>
<span><span class="co"># )</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cluster_samples_count</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">sample</span>, y <span class="op">=</span> <span class="va">prop</span>, fill <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sample composition (T/NK clusters)"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">### How many cells of each sample in each cluster? (by sample)</span></span>
<span><span class="va">cluster_samples_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">$</span><span class="va">SCT_snn_res.1</span>, <span class="va">Tcells</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>,</span>
<span>    margin <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cluster <span class="op">=</span> <span class="va">Var1</span>, sample <span class="op">=</span> <span class="va">Var2</span>, prop <span class="op">=</span> <span class="va">Freq</span><span class="op">)</span></span>
<span><span class="co"># write.csv(</span></span>
<span><span class="co">#     cluster_samples_prop,</span></span>
<span><span class="co">#     here(Tcell_dir, "cluster_samples_proportion.csv"),</span></span>
<span><span class="co">#     row.names = TRUE</span></span>
<span><span class="co"># )</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cluster_samples_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cluster</span>, y <span class="op">=</span> <span class="va">prop</span>, fill <span class="op">=</span> <span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"T/NK cell cluster composition"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### How many cells of each IE are in each cluster</span></span>
<span><span class="va">cluster_IE_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">$</span><span class="va">SCT_snn_res.1</span>, <span class="va">Tcells</span><span class="op">$</span><span class="va">IE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cluster <span class="op">=</span> <span class="va">Var1</span>, IE <span class="op">=</span> <span class="va">Var2</span>, count <span class="op">=</span> <span class="va">Freq</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cluster_IE_count</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cluster</span>, y <span class="op">=</span> <span class="va">count</span>, fill<span class="op">=</span><span class="va">IE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="co">#coord_flip()+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"T/NK cell cluster composition"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### What percentage of each IE is in which cluster?</span></span>
<span><span class="va">cluster_IE_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">$</span><span class="va">SCT_snn_res.1</span>, <span class="va">Tcells</span><span class="op">$</span><span class="va">IE</span><span class="op">)</span>,</span>
<span>    margin <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cluster <span class="op">=</span> <span class="va">Var1</span>, IE <span class="op">=</span> <span class="va">Var2</span>, prop <span class="op">=</span> <span class="va">Freq</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cluster_IE_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cluster</span>, y <span class="op">=</span> <span class="va">prop</span>, fill <span class="op">=</span> <span class="va">IE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, position <span class="op">=</span> <span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Proportion of each TIG belonging to a specific cluster"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cluster_IE_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">IE</span>, y <span class="op">=</span> <span class="va">prop</span>, fill <span class="op">=</span> <span class="va">IE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span></span>
<span>        <span class="op">~</span> <span class="va">cluster</span>, scales <span class="op">=</span> <span class="st">"free"</span>, </span>
<span>        ncol <span class="op">=</span> <span class="fl">3</span>, </span>
<span>        strip.position <span class="op">=</span> <span class="st">"bottom"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span><span class="st">"cluster"</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># theme(panel.background = element_blank())+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"cluster"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="finding-cluster-deg" class="level3"><h3 class="anchored" data-anchor-id="finding-cluster-deg">Finding cluster DEG</h3>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">Tcells</span><span class="op">$</span><span class="va">SCT_snn_res.1</span></span>
<span><span class="va">Tcells_markers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html">FindAllMarkers</a></span><span class="op">(</span></span>
<span>    <span class="va">Tcells</span>, only.pos <span class="op">=</span> <span class="cn">TRUE</span>, min.pct <span class="op">=</span> <span class="fl">0.25</span>, logfc.threshold <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="op">)</span></span>
<span><span class="va">marker_genes_top10</span> <span class="op">&lt;-</span> <span class="va">Tcells_markers</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">avg_log2FC</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Feature list</span></span>
<span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"FOXP3"</span>, <span class="st">"CCL18"</span>, <span class="st">"IL2RA"</span><span class="op">)</span></span>
<span><span class="va">features_cytof</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CD3E'</span>, <span class="st">'CD8A'</span>, <span class="st">'CD4'</span>, <span class="st">'FOXP3'</span>, <span class="st">'HAVCR2'</span>, <span class="st">'PDCD1'</span>, <span class="st">'CTLA4'</span>, <span class="st">'ICOS'</span>, </span>
<span>    <span class="st">'IL2RA'</span>, <span class="st">'PTPRC'</span>, <span class="st">'CD68'</span>, <span class="st">'CD14'</span>, <span class="st">'CD274'</span>, <span class="st">'CCR7'</span>, <span class="st">'HLA-DRA'</span>, <span class="st">'MRC1'</span>, </span>
<span>    <span class="st">'SIGLEC1'</span>, <span class="st">'MSR1'</span>, <span class="st">'CD163'</span>, <span class="st">'FCGR2A'</span>, <span class="st">'FCGR2B'</span>, <span class="st">'FCGR2C'</span>, <span class="st">'FCGR1A'</span>, </span>
<span>    <span class="st">'ITGAM'</span>, <span class="st">'ITGAX'</span>, <span class="st">'FCGR3A'</span>, <span class="st">'CD93'</span>, <span class="st">'IL3RA'</span>, <span class="st">'CD86'</span>, <span class="st">'CD36'</span>, <span class="st">'CD38'</span>, </span>
<span>    <span class="st">'CCR2'</span>, <span class="st">'SLAMF7'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">features_cytof_T_01</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'CD3E'</span>, <span class="st">'CD8A'</span>, <span class="st">'FOXP3'</span>, <span class="st">'HAVCR2'</span>, <span class="st">'PDCD1'</span>, <span class="st">'CTLA4'</span><span class="op">)</span></span>
<span><span class="va">features_cytof_T_02</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'ICOS'</span>, <span class="st">'IL2RA'</span>, <span class="st">'PTPRC'</span>, <span class="st">'CD4'</span>, <span class="st">'CCR7'</span>, <span class="st">'CD38'</span><span class="op">)</span></span>
<span><span class="va">features_cytof_T</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CD3E'</span>, <span class="st">'CD8A'</span>, <span class="st">'FOXP3'</span>, <span class="st">'HAVCR2'</span>, <span class="st">'PDCD1'</span>, <span class="st">'CTLA4'</span>, <span class="st">'ICOS'</span>, <span class="st">'IL2RA'</span>, </span>
<span>    <span class="st">'PTPRC'</span>, <span class="st">'CD4'</span>, <span class="st">'CCR7'</span>, <span class="st">'CD38'</span>, <span class="st">'NCAM1'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">features_T_extended</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CD3E'</span>, <span class="st">'CD8A'</span>, <span class="st">'FOXP3'</span>, <span class="st">'HAVCR2'</span>, <span class="st">'PDCD1'</span>, <span class="st">'CTLA4'</span>, <span class="st">'ICOS'</span>, <span class="st">'IL2RA'</span>, </span>
<span>    <span class="st">'PTPRC'</span>, <span class="st">'CD4'</span>, <span class="st">'CCR7'</span>, <span class="st">'CD38'</span>, <span class="st">'NCAM1'</span>, <span class="st">'ENTPD1'</span>, <span class="st">'ITGAE'</span>, <span class="st">'SELL'</span>, </span>
<span>    <span class="st">'CD40LG'</span>, <span class="st">"FCGR3A"</span>, <span class="st">"CD27"</span>, <span class="st">"IL7R"</span>, <span class="st">"HLA-DRA"</span>, <span class="st">"TBX21"</span>, <span class="st">"CD69"</span>, <span class="st">"NCR1"</span>, </span>
<span>    <span class="st">"IRF4"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cytokine</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CCL20'</span>, <span class="st">'CCL22'</span>, <span class="st">'CXCL2'</span>, <span class="st">'CXCL3'</span>, <span class="st">'CXCL8'</span>, <span class="st">'CCL8'</span>, <span class="st">'CCL18'</span>, <span class="st">'CCL2'</span>, </span>
<span>    <span class="st">'CCL3'</span>, <span class="st">'CCL4'</span>, <span class="st">'CCL4L2'</span>, <span class="st">'CCL5'</span>, <span class="st">'CXCL10'</span>, <span class="st">'CXCL12'</span>, <span class="st">'CCL13'</span>, <span class="st">'CXCL1'</span>, </span>
<span>    <span class="st">'CXCL13'</span>, <span class="st">"IL4"</span>, <span class="st">"IL13"</span>, <span class="st">"IFNG"</span>, <span class="st">"TNF"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">chemokine_01</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'CCL20'</span>, <span class="st">'CCL22'</span>, <span class="st">'CXCL2'</span>, <span class="st">'CXCL3'</span>, <span class="st">'CXCL8'</span><span class="op">)</span></span>
<span><span class="va">chemokine_02</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'CCL8'</span>, <span class="st">'CCL18'</span>, <span class="st">'CCL2'</span>, <span class="st">'CCL3'</span>, <span class="st">'CCL4'</span><span class="op">)</span></span>
<span><span class="va">chemokine_03</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'CCL4L2'</span>, <span class="st">'CXCL10'</span>, <span class="st">'CXCL12'</span>, <span class="st">'CCL13'</span>, <span class="st">'CXCL1'</span><span class="op">)</span></span>
<span><span class="va">cytokine_receptor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CCR1'</span>, <span class="st">'CCR10'</span>, <span class="st">'CCR2'</span>, <span class="st">'CCR7'</span>, <span class="st">'CCR4'</span>, <span class="st">'CCR5'</span>, <span class="st">'CCR6'</span>, <span class="st">'IL10RA'</span>, </span>
<span>    <span class="st">'IL4R'</span>, <span class="st">'CXCR2'</span>, <span class="st">'CXCR3'</span>, <span class="st">'CXCR4'</span>, <span class="st">'CXCR5'</span>, <span class="st">'CCR8'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">TF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'IRF2'</span>, <span class="st">'IRF5'</span>, <span class="st">'IRF8'</span>, <span class="st">'IRF9'</span>, <span class="st">'IRF4'</span>, <span class="st">'IRF7'</span>, <span class="st">'STAT1'</span>, <span class="st">'STAT2'</span>, <span class="st">'STAT4'</span>, </span>
<span>    <span class="st">'TCF12'</span>, <span class="st">'TCF19'</span>, <span class="st">'BCL6'</span>, <span class="st">'ZBTB31'</span>, <span class="st">'ZBTB33'</span>, <span class="st">'ZBTB47'</span>, <span class="st">'CIITA'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">features_plitas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CCR8'</span>, <span class="st">'CCR10'</span>, <span class="st">'CX3CR1'</span>, <span class="st">'IL1RL1'</span>, <span class="st">'IL2RA'</span>, <span class="st">'IL1R2'</span>, <span class="st">'TNFRSF8'</span>, </span>
<span>    <span class="st">'TNFRSF4'</span>, <span class="st">'TNFRSF9'</span>, <span class="st">'TNFRSF18'</span>, <span class="st">'CD177'</span>, <span class="st">'CARD16'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Th1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'CCL4'</span>, <span class="st">'CD38'</span>, <span class="st">'CXCL9'</span>, <span class="st">'CXCL10'</span>, <span class="st">'CXCL11'</span>, <span class="st">'FN1'</span>, <span class="st">'GNLY'</span>, <span class="st">'GZMA'</span>, </span>
<span>    <span class="st">'GZMB'</span>, <span class="st">'IFNA'</span>, <span class="st">'IFNG'</span>, <span class="st">'IL2'</span>, <span class="st">'IL8'</span>, <span class="st">'IL10'</span>, <span class="st">'IL12B'</span>, <span class="st">'IL18'</span>, <span class="st">'LTA'</span>, </span>
<span>    <span class="st">'MAP3K8'</span>, <span class="st">'OSM'</span>, <span class="st">'STAT1'</span>, <span class="st">'STAT4'</span>, <span class="st">'TBX21'</span>, <span class="st">'TIA1'</span>, <span class="st">'TNF'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">Th2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'GATA3'</span>, <span class="st">'IL4'</span>, <span class="st">'IL5'</span>, <span class="st">'IL10'</span>, <span class="st">'IL13'</span>, <span class="st">'MAF'</span>, <span class="st">'STAT5A'</span>, <span class="st">'STAT5B'</span>, <span class="st">'STAT6'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">Th17</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">'BATF'</span>, <span class="st">'CCL20'</span>, <span class="st">'IL1A'</span>, <span class="st">'IL1B'</span>, <span class="st">'IL6'</span>, <span class="st">'IL17A'</span>, <span class="st">'IL17F'</span>, <span class="st">'IL18'</span>, <span class="st">'IL21'</span>, </span>
<span>    <span class="st">'IL22'</span>, <span class="st">'LTA'</span>, <span class="st">'RORC'</span>, <span class="st">'STAT3'</span>, <span class="st">'TGFB1'</span>, <span class="st">'TGFB2'</span>, <span class="st">'TGFB3'</span></span>
<span><span class="op">)</span></span>
<span><span class="va">tumor_reactive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"PDCD1"</span>, <span class="st">"LAG3"</span>, <span class="st">"HAVCR2"</span>, <span class="st">"TNFRSF9"</span>, <span class="st">"TNFRSF18"</span>, <span class="st">"ENTPD1"</span>, <span class="st">"ITGAE"</span>, </span>
<span>    <span class="st">"CXCL13"</span>, <span class="st">"IRF4"</span>, <span class="st">"BATF"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cytotoxic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"GZMB"</span>, <span class="st">"GZMA"</span>, <span class="st">"GZMK"</span>, <span class="st">"TNF"</span>, <span class="st">"IFNG"</span>, <span class="st">"GNLY"</span>, <span class="st">"FASLG"</span>, <span class="st">"IL2"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">M1M2_rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"IL10RA"</span>, <span class="st">"IL10RB"</span>, <span class="st">"CXCR3"</span>, <span class="st">"CCR4"</span>, <span class="st">"CCR1"</span>, <span class="st">"CCR5"</span>, <span class="st">"IGF2R"</span>, <span class="st">"TFGBR2"</span>, </span>
<span>    <span class="st">"TGFBR1"</span>, <span class="st">"TGFBR3"</span>, <span class="st">"ITGAV"</span>, <span class="st">"ITGA5"</span>, <span class="st">"LRP8"</span>, <span class="st">"LRP1"</span>, <span class="st">"SCARB1"</span>, <span class="st">"C3AR1"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">M1M2_lig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"CALM1"</span>, <span class="st">"CALM2"</span>, <span class="st">"CALM3"</span>, <span class="st">"TGFB1"</span>, <span class="st">"TLN1"</span>, <span class="st">"HSP90AA1"</span>, <span class="st">"VEGFA"</span>, <span class="st">"GNAI2"</span>, </span>
<span>    <span class="st">"PGF"</span>, <span class="st">"MDK"</span>, <span class="st">"FGF2"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcells</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"Tcell_metacluster"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcells</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"Tcell_cluster"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">Tcells</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, group.by <span class="op">=</span> <span class="st">"cell_type"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="correlation-matrix" class="level3"><h3 class="anchored" data-anchor-id="correlation-matrix">Correlation matrix</h3>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">Tcells</span><span class="op">$</span><span class="va">SCT_snn_res.1</span></span>
<span><span class="va">cluster_perc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">)</span>, <span class="va">Tcells</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">cluster_perc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">cluster_perc</span><span class="op">)</span></span>
<span><span class="va">corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span><span class="op">(</span><span class="va">cluster_perc</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### For metaclusters</span></span>
<span><span class="va">T_mcluster_perc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">$</span><span class="va">Tcell_metacluster</span>, <span class="va">Tcells</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="va">T_mcluster_perc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">T_mcluster_perc</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html">corrplot</a></span><span class="op">(</span></span>
<span>    <span class="va">corr</span>, method <span class="op">=</span> <span class="st">"color"</span>, type <span class="op">=</span> <span class="st">"upper"</span>, tl.srt <span class="op">=</span> <span class="fl">0</span>, tl.offset <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    tl.cex <span class="op">=</span> <span class="fl">1</span>, tl.col <span class="op">=</span> <span class="st">"black"</span>, title <span class="op">=</span> <span class="st">"Tcell cluster correlations"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compute p-values</span></span>
<span><span class="va">p_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/cor.mtest.html">cor.mtest</a></span><span class="op">(</span><span class="va">corr</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span><span class="va">p_corr2</span> <span class="op">&lt;-</span> <span class="va">p_corr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co">### Plot with p-values below zero in white</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html">corrplot</a></span><span class="op">(</span></span>
<span>    <span class="va">corr</span>, method <span class="op">=</span> <span class="st">"color"</span>, type <span class="op">=</span> <span class="st">"upper"</span>, tl.srt <span class="op">=</span> <span class="fl">0</span>, tl.col <span class="op">=</span> <span class="st">"black"</span>, tl.offset <span class="op">=</span> <span class="fl">1</span>, p.mat <span class="op">=</span> <span class="va">p_corr2</span>, </span>
<span>    sig.level <span class="op">=</span> <span class="fl">0.005</span>, insig <span class="op">=</span> <span class="st">"label_sig"</span>, </span>
<span>    pch <span class="op">=</span> <span class="st">"*"</span>, pch.cex <span class="op">=</span> <span class="fl">1</span>, title <span class="op">=</span> <span class="st">"Tcell cluster correlations (P&lt;0.05)"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="cd4cd8-ratio" class="level3"><h3 class="anchored" data-anchor-id="cd4cd8-ratio">CD4/CD8 ratio</h3>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Idents(Tcells) &lt;- Tcells$Tcell_metacluster</span></span>
<span><span class="co"># levels(Idents(Tcells))</span></span>
<span><span class="co"># T_only &lt;- subset(</span></span>
<span><span class="co">#     Tcells, idents = c("NKT", "NK_activated", "NK", "proliferating"), </span></span>
<span><span class="co">#     invert = TRUE</span></span>
<span><span class="co"># )</span></span>
<span></span>
<span><span class="co"># cluster_averages &lt;- AverageExpression(T_only, return.seurat = TRUE)</span></span>
<span><span class="co"># dim(cluster_averages)</span></span>
<span><span class="co"># dim(cluster_averages_df)</span></span>
<span><span class="co"># rownames(cluster_averages_df) &lt;- rownames(cluster_averages)</span></span>
<span><span class="co"># cluster_averages_df &lt;- as.data.frame(cluster_averages@assays$RNA@layers$counts)</span></span>
<span><span class="co"># colnames(cluster_averages_df)</span></span>
<span><span class="co"># colnames(cluster_averages)</span></span>
<span></span>
<span><span class="co"># CD8_CD4_df &lt;- as.data.frame(</span></span>
<span><span class="co">#     t(cluster_averages_df[c("CD8A", "CD8B", "CD4"), ])</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># CD8_CD4_df$cluster &lt;- rownames(CD8.CD4.df)</span></span>
<span><span class="co"># CD8.CD4.df &lt;- mutate(CD8.CD4.df, ratio = (CD8A + CD8B) / 2 / CD4)</span></span>
<span></span>
<span><span class="co"># p &lt;- ggplot(CD8.CD4.df, aes(cluster, ratio)) +</span></span>
<span><span class="co">#     geom_point() +</span></span>
<span><span class="co">#     ylab("CD8/CD4 ratio") +</span></span>
<span><span class="co">#     theme(panel.background = element_blank(),</span></span>
<span><span class="co">#         panel.border = element_rect(color = "black", fill = NA, size = 1))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="t-cells-edger-pseudobulk" class="level2"><h2 class="anchored" data-anchor-id="t-cells-edger-pseudobulk">T cells EdgeR pseudobulk</h2>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Cluster-indepenent IE comparsion</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TBB011"</span>, <span class="st">"TBB165"</span>, <span class="st">"TBB338"</span>, <span class="st">"TBB075"</span>, <span class="st">"TBB214"</span>, <span class="st">"TBB330"</span><span class="op">)</span></span>
<span><span class="va">raw_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">layers</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/ObjectAccess.html">Assays</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">Tcells</span><span class="op">[[</span><span class="st">"RNA"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Get the counts matrix</span></span>
<span><span class="va">raw_counts</span><span class="op">$</span><span class="va">TBB011</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"TBB011"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">raw_counts</span><span class="op">$</span><span class="va">TBB165</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"TBB165"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">raw_counts</span><span class="op">$</span><span class="va">TBB338</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"TBB338"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">raw_counts</span><span class="op">$</span><span class="va">TBB075</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"TBB075"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">raw_counts</span><span class="op">$</span><span class="va">TBB330</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"TBB330"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">raw_counts</span><span class="op">$</span><span class="va">TBB214</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"TBB214"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">raw_counts</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raw_sums</span> <span class="op">&lt;-</span> <span class="va">raw_counts</span><span class="op">[</span>, <span class="va">samples</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span><span class="va">raw_sums</span>, <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">Tcell_dir</span>, <span class="st">"sample_sum_counts.csv"</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Load count data</span></span>
<span><span class="va">scrna_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq"</span><span class="op">)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">Tcell_dir</span>, <span class="st">"sample_sum_counts.csv"</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="st">"X"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Get group information</span></span>
<span><span class="va">clinical_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">scrna_dir</span>, <span class="st">"03_Additional_files/clinical_data.csv"</span><span class="op">)</span>,</span>
<span>    show_col_types <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sample <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue</a></span><span class="op">(</span><span class="st">"T{Patient_ID}"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">sample</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">samples</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">IE</span>, .before <span class="op">=</span> <span class="va">Patient_ID</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">IE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Preapre a DGElist object</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">edgeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/DGEList.html">DGEList</a></span><span class="op">(</span></span>
<span>    counts <span class="op">=</span> <span class="va">counts</span>, group <span class="op">=</span> <span class="va">clinical_data</span><span class="op">$</span><span class="va">IE</span>, samples <span class="op">=</span> <span class="va">clinical_data</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Filter out lowly expressed genes</span></span>
<span><span class="va">keep</span> <span class="op">&lt;-</span> <span class="fu">edgeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/filterByExpr.html">filterByExpr</a></span><span class="op">(</span></span>
<span>    <span class="va">obj</span>, group <span class="op">=</span> <span class="va">clinical_data</span><span class="op">$</span><span class="va">IE</span>,</span>
<span>    min.count <span class="op">=</span> <span class="fl">30</span>, min.total.count <span class="op">=</span> <span class="fl">300</span>, large.n <span class="op">=</span> <span class="fl">4</span>, min.prop <span class="op">=</span> <span class="fl">0.6</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">keep</span><span class="op">)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">[</span><span class="va">keep</span>, , keep.lib.sizes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### Normalisation for RNA composition using TMM (trimmed mean of M-values)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu">edgeR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/calcNormFactors.html">calcNormFactors</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="va">samples</span></span>
<span></span>
<span><span class="co">### Setup the design matrix</span></span>
<span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">clinical_data</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></span>
<span><span class="va">IE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">clinical_data</span><span class="op">$</span><span class="va">IE</span><span class="op">)</span></span>
<span><span class="va">IE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">IE</span>, <span class="st">"IE2"</span><span class="op">)</span></span>
<span><span class="va">design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">IE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Estimate dispersion (estimates common dispersion, trended dispersions and</span></span>
<span><span class="co">### tagwise dispersions in one run)</span></span>
<span><span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/estimateDisp.html">estimateDisp</a></span><span class="op">(</span><span class="va">obj</span>, <span class="va">design</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/plotBCV.html">plotBCV</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Calcualte differential expression</span></span>
<span><span class="co">### exact test (only for single-factor experiments)</span></span>
<span><span class="va">et</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/exactTest.html">exactTest</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/topTags.html">topTags</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Number of up/downregulated genes at 5% FDR</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/decideTests.html">decideTests</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/plotMD.html">plotMD</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Export results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/edgeR/man/topTags.html">topTags</a></span><span class="op">(</span><span class="va">et</span>, n<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">Tcell_dir</span>, <span class="st">"IE1vsIE2_EdgeR_samplesums_exactT_filtered.csv"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="figure1" class="level2"><h2 class="anchored" data-anchor-id="figure1">Figure1</h2>
<section id="umap-plots" class="level3"><h3 class="anchored" data-anchor-id="umap-plots">UMAP plots</h3>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects/2023_NC_BCexh/BCexh_scRNAseq"</span><span class="op">)</span></span>
<span><span class="va">all_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"output/merged_complete_umap.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Color palette</span></span>
<span><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://scales.r-lib.org/reference/pal_hue.html">hue_pal</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://scales.r-lib.org/reference/show_col.html">show_col</a></span><span class="op">(</span><span class="va">colors</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Classify pDCs as myeloid cells for this large overview</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">cell_type</span><span class="op">)</span></span>
<span><span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span><span class="op">)</span></span>
<span><span class="va">ct_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span><span class="op">)</span></span>
<span><span class="va">ct_levels</span><span class="op">[</span><span class="fl">6</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"mast cell/basophil"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">ct_levels</span></span>
<span></span>
<span><span class="co">### Reorder patient levels</span></span>
<span><span class="va">all_merged</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Subset to very few cells to get small pdfs</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/WhichCells.html">WhichCells</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">)</span></span>
<span><span class="va">cells_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">cells</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">all_merged</span>, cells <span class="op">=</span> <span class="va">cells_sub</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Color by celltype</span></span>
<span><span class="va">umap_celltype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">object</span>, group.by <span class="op">=</span> <span class="st">"cell_type"</span>,</span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"#FF5F50"</span>, <span class="st">"darkorange2"</span>, <span class="st">"gold3"</span>, <span class="st">"#77C900"</span>, <span class="st">"#00AA5C"</span>, <span class="st">"#00C0BD"</span>, <span class="st">"#1F99FF"</span>, <span class="st">"#0044DB"</span>, <span class="st">"gray"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Color by sample</span></span>
<span><span class="va">umap_patient</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">object</span>, group.by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">umap_celltype</span> <span class="op">+</span>  <span class="va">umap_patient</span></span>
<span></span>
<span><span class="co">### Color by sample group</span></span>
<span><span class="va">umap_IE</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">object</span>, group.by <span class="op">=</span> <span class="st">"IE"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Color by clusters</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">all_merged</span>, group.by <span class="op">=</span> <span class="st">"RNA_snn_res.2"</span>, label <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="highlight-fibroblast" class="level3"><h3 class="anchored" data-anchor-id="highlight-fibroblast">Highlight fibroblast</h3>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span></span>
<span><span class="va">fibroblasts</span>  <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/WhichCells.html">WhichCells</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">all_merged</span>, ident <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"fibroblast"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">all_merged</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, cells.highlight <span class="op">=</span> <span class="va">fibroblasts</span>, </span>
<span>    cols.highlight <span class="op">=</span> <span class="st">"#00C1AA"</span>, sizes.highlight <span class="op">=</span> <span class="fl">0.7</span>, pt.size <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="feature-plots" class="level3"><h3 class="anchored" data-anchor-id="feature-plots">Feature plots</h3>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### save as png (Inkscape/Illustrator cannot handle UMAPs with lots of cells)</span></span>
<span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PTPRC"</span>, <span class="st">"PDGFRB"</span>, <span class="st">"CD3E"</span>, <span class="st">"CD14"</span>, <span class="st">"EPCAM"</span>, <span class="st">"PECAM1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">all_merged</span>, <span class="va">genes</span>, max.cutoff <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### save one plot as pdf to get vectorized legend (with very few cells)</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/WhichCells.html">WhichCells</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">)</span></span>
<span><span class="va">cells_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">cells</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">obj_sub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">all_merged</span>, cells <span class="op">=</span> <span class="va">cells_sub</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/FeaturePlot.html">FeaturePlot</a></span><span class="op">(</span><span class="va">obj_sub</span>, <span class="st">"HLA-DRA"</span>, max.cutoff <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="dotplots-for-lineage-markers" class="level3"><h3 class="anchored" data-anchor-id="dotplots-for-lineage-markers">Dotplots for lineage markers</h3>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Features</span></span>
<span><span class="va">genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"EPCAM"</span>, <span class="st">"CDH1"</span>, <span class="st">"PECAM1"</span>, <span class="st">"CAV1"</span>, <span class="st">"VWF"</span>, <span class="st">"PDGFRB"</span>, <span class="st">"FAP"</span>, <span class="st">"PTPRC"</span>, <span class="st">"CD3E"</span>, <span class="st">"NCAM1"</span>, <span class="st">"CD14"</span>, <span class="st">"HLA-DRA"</span>, <span class="st">"ITGAX"</span>, <span class="st">"MS4A1"</span>, <span class="st">"MS4A2"</span>, <span class="st">"IGKC"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">genes_PDL1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CD274"</span>, <span class="st">"LAMP3"</span>, <span class="st">"CCR7"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Main cell types only</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DotPlot.html">DotPlot</a></span><span class="op">(</span><span class="va">all_merged</span>, features <span class="op">=</span> <span class="va">genes_PDL1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">### all clusters</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">all_merged</span><span class="op">$</span><span class="va">RNA_snn_res.2</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DotPlot.html">DotPlot</a></span><span class="op">(</span><span class="va">all_merged</span>, features <span class="op">=</span> <span class="va">genes_PDL1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="gene-expression-heatmap" class="level3"><h3 class="anchored" data-anchor-id="gene-expression-heatmap">Gene expression heatmap</h3>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span></span>
<span><span class="va">cluster_averages_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/AverageExpression.html">AverageExpression</a></span><span class="op">(</span></span>
<span>    <span class="va">all_merged</span>, return.seurat <span class="op">=</span> <span class="cn">FALSE</span>, assays <span class="op">=</span> <span class="st">"RNA"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">RNA_average</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">cluster_averages_table</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Normalize between 0 and 1</span></span>
<span><span class="va">RNA_average_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span></span>
<span>    <span class="va">RNA_average</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">RNA_average_znorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">RNA_average</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">T_supp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"CD274"</span>, <span class="st">"PDCD1LG2"</span>, <span class="st">"IDO1"</span>, <span class="st">"CD80"</span>, <span class="st">"CD86"</span>, <span class="st">"CCL17"</span>, <span class="st">"CCL19"</span>, <span class="st">"CCL22"</span>, <span class="st">"IL15"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html">Heatmap</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">RNA_average_norm</span>, select <span class="op">=</span> <span class="va">T_supp</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    show_row_names <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    row_dend_side <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Normalized\nmean counts"</span><span class="op">)</span>,</span>
<span>    col <span class="op">=</span> <span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>    cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    row_names_side <span class="op">=</span> <span class="st">"left"</span>,</span>
<span>    column_names_side <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    column_names_rot <span class="op">=</span> <span class="fl">90</span>,</span>
<span>    column_dend_side <span class="op">=</span> <span class="st">"bottom"</span>,</span>
<span>    row_names_gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html">gpar</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>    cluster_column_slices <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="cell-type-frequence" class="level3"><h3 class="anchored" data-anchor-id="cell-type-frequence">Cell type frequence</h3>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### classify pDCs as myeloid cells for this large overview</span></span>
<span><span class="va">sample_info</span> <span class="op">&lt;-</span> <span class="va">all_merged</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sample</span>, <span class="va">IE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Full clusters by sample</span></span>
<span><span class="va">cluster_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">$</span><span class="va">sample</span>, <span class="va">all_merged</span><span class="op">$</span><span class="va">RNA_snn_res.2</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">cluster_prop</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample"</span>, <span class="st">"cluster"</span>, <span class="st">"proportion"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cluster_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">cluster</span>, y <span class="op">=</span> <span class="va">proportion</span>, fill <span class="op">=</span> <span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sample composition by cell type"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Compare cell type frequencies</span></span>
<span><span class="va">celltype_freq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span>, <span class="va">all_merged</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">celltype_freq</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cell_type"</span>, <span class="st">"sample"</span>, <span class="st">"cell_number"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Absolute frequency</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_freq</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">sample</span>, y <span class="op">=</span> <span class="va">cell_number</span>, fill <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sample composition by cell type (absolute)"</span><span class="op">)</span> <span class="co">## Figure2</span></span>
<span></span>
<span><span class="co">### Relative frequency</span></span>
<span><span class="va">celltype_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">all_merged</span><span class="op">$</span><span class="va">cell_type</span>, <span class="va">all_merged</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">celltype_prop</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cell_type"</span>, <span class="st">"sample"</span>, <span class="st">"proportion"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">sample</span>, y <span class="op">=</span> <span class="va">proportion</span>, fill <span class="op">=</span> <span class="va">cell_type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># coord_flip()+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Sample composition by cell type"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Cell type proporations by sample group</span></span>
<span><span class="va">celltype_prop</span> <span class="op">&lt;-</span> <span class="va">celltype_prop</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">sample_info</span>, by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">IE</span>, y <span class="op">=</span> <span class="va">proportion</span>, color <span class="op">=</span> <span class="va">IE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cell_type</span>, scales <span class="op">=</span> <span class="st">"fixed"</span>, ncol <span class="op">=</span> <span class="fl">4</span>, strip.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="cn">NA</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Of total [%]"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="cytof-vs-10x" class="level3"><h3 class="anchored" data-anchor-id="cytof-vs-10x">Cytof vs 10x</h3>
</section><section id="cell-numbers-before-and-after-filtering" class="level3"><h3 class="anchored" data-anchor-id="cell-numbers-before-and-after-filtering">Cell numbers before and after filtering</h3>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cell_numbers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"03_Additional_files/CellsPerSample_PrePostFilter.csv"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">15</span>, <span class="op">-</span><span class="fl">4</span><span class="op">]</span></span>
<span></span>
<span><span class="va">cell_numbers</span><span class="op">$</span><span class="va">preFilter</span> <span class="op">&lt;-</span> <span class="va">cell_numbers</span><span class="op">$</span><span class="va">preFilter</span> <span class="op">-</span> <span class="va">cell_numbers</span><span class="op">$</span><span class="va">postFilter</span></span>
<span><span class="va">cell_numbers</span> <span class="op">&lt;-</span> <span class="va">cell_numbers</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"Filter"</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"filter"</span>, values_to <span class="op">=</span> <span class="st">"cell_number"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>        filter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>            <span class="va">filter</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"preFilter"</span>, <span class="st">"postFilter"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">cell_numbers</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Sample</span>, <span class="va">cell_number</span>, fill <span class="op">=</span> <span class="va">filter</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span></span>
<span>        values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"preFilter"</span> <span class="op">=</span> <span class="st">"dodgerblue"</span>, <span class="st">"postFilter"</span> <span class="op">=</span> <span class="st">"green4"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Cell number"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="clinical-information" class="level3"><h3 class="anchored" data-anchor-id="clinical-information">Clinical information</h3>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"03_Additional_files/subtype_table.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="fl">28</span><span class="op">:</span><span class="fl">32</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### Subtype distribution by TIG (stacked barplot)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">Clinical.Subtype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">Clinical.Subtype</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LumA"</span>, <span class="st">"LumB"</span>, <span class="st">"LumB-HER2"</span>, <span class="st">"HER2"</span>, <span class="st">"TN"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">p_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Clinical.Subtype</span>, fill <span class="op">=</span> <span class="va">Tumor.Immune.Group..CyTOF.based.</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">6</span>,<span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>         axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>         axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Clinical Subtypes by TIG"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Age distribution by TIG (boxplots)</span></span>
<span><span class="va">p_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Tumor.Immune.Group..CyTOF.based.</span>, y <span class="op">=</span> <span class="va">Age.at.Surgery</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>         axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>         axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Age by TIG"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Grade distribution by TIG (stacked barplot)</span></span>
<span><span class="va">p_grade</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">Grade</span>, fill <span class="op">=</span> <span class="va">Tumor.Immune.Group..CyTOF.based.</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html">scale_x_discrete</a></span><span class="op">(</span>drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">6</span>,<span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>         axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>         axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Grade by TIG"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Combine plots</span></span>
<span><span class="op">(</span><span class="va">p_type</span> <span class="op">|</span> <span class="va">p_age</span> <span class="op">|</span> <span class="va">p_grade</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">### Cell type freq distribution by clinical subtype (boxplots)</span></span>
<span><span class="va">celltype_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"03_Additional_files/celltype_prop_sample_v2.csv"</span><span class="op">)</span>, </span>
<span>    header <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">df</span>, by <span class="op">=</span> <span class="st">"Patient.ID"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>        cols <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">9</span>, names_to <span class="op">=</span> <span class="st">"cell_type"</span>, values_to <span class="op">=</span> <span class="st">"proportion"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">cell_type</span>, <span class="va">proportion</span>, .after <span class="op">=</span> <span class="st">"Patient.ID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sign_testing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/compare_means.html">compare_means</a></span><span class="op">(</span></span>
<span>    <span class="va">proportion</span> <span class="op">~</span> <span class="va">Clinical.Subtype</span>, data <span class="op">=</span> <span class="va">celltype_prop</span>, </span>
<span>    group.by <span class="op">=</span> <span class="st">"cell_type"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Clinical.Subtype</span>, y <span class="op">=</span> <span class="va">proportion</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cell_type</span>, scales<span class="op">=</span><span class="st">"fixed"</span>, ncol<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>         axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>         axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Cell type frequency by subtype"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/stat_compare_means.html">stat_compare_means</a></span><span class="op">(</span>comparisons<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LumA"</span>, <span class="st">"LumB"</span><span class="op">)</span><span class="op">)</span>, label <span class="op">=</span> <span class="st">"p.signif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Cell type freq distribution by grade (boxplots)</span></span>
<span><span class="va">sign_testing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/compare_means.html">compare_means</a></span><span class="op">(</span></span>
<span>    <span class="va">proportion</span><span class="op">~</span><span class="va">Grade</span>, data <span class="op">=</span> <span class="va">celltype_prop</span>, group.by <span class="op">=</span> <span class="st">"cell_type"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_comparisons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G2"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"G1"</span>, <span class="st">"G3"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"G2"</span>, <span class="st">"G3"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Grade</span>, y <span class="op">=</span> <span class="va">proportion</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cell_type</span>, scales<span class="op">=</span><span class="st">"fixed"</span>, ncol<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>         axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>         axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Cell type frequency by subtype"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.7</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/stat_compare_means.html">stat_compare_means</a></span><span class="op">(</span>comparisons <span class="op">=</span> <span class="va">my_comparisons</span>, label <span class="op">=</span> <span class="st">"p.signif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Cell type freq by age (correlation plots)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">celltype_prop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">proportion</span>, <span class="va">Age.at.Surgery</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">cell_type</span>, scales <span class="op">=</span> <span class="st">"free"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/stat_cor.html">stat_cor</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>         panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>         strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Cell type frequency by age"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="figure2" class="level2"><h2 class="anchored" data-anchor-id="figure2">Figure2</h2>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Tcells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">scrna_dir</span>, <span class="st">"output/Tcells.rds"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="ie1-vs-ie2-volcano-plot" class="level3"><h3 class="anchored" data-anchor-id="ie1-vs-ie2-volcano-plot">IE1 vs IE2 Volcano Plot</h3>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">edger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">Tcell_dir</span>, <span class="st">"IE1vsIE2_EdgeR_samplesums_exactT_filtered.csv"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">edger</span><span class="op">$</span><span class="va">logFC</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="op">(</span><span class="va">edger</span><span class="op">$</span><span class="va">logFC</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Remove keratins</span></span>
<span><span class="va">edger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">edger</span>, <span class="op">!</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">X</span>, <span class="st">"^KRT"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">edger</span><span class="op">$</span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">edger</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Remove all genes with logCPM &lt; 1.5</span></span>
<span><span class="va">edger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">edger</span>, <span class="va">logCPM</span> <span class="op">&gt;</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">highlight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"HAVCR"</span>, <span class="st">"CDK1"</span>, <span class="st">"PTMS"</span>, <span class="st">"CSF1"</span>, <span class="st">"CD55"</span>, <span class="st">"GZMB"</span>, <span class="st">"PDCD1"</span>, <span class="st">"IL13"</span>,</span>
<span>    <span class="st">"MKI67"</span>, <span class="st">"TNFRSF18"</span>, <span class="st">"CD276"</span>, <span class="st">"IRF4"</span>, <span class="st">"ITGAE"</span>, <span class="st">"CD8B"</span>, <span class="st">"TCF7"</span>,</span>
<span>    <span class="st">"PDCD4"</span>, <span class="st">"GPR183"</span>, <span class="st">"CAMK1"</span>, <span class="st">"HAVCR2"</span>, <span class="st">"BATF"</span>, <span class="st">"TOX"</span>, <span class="st">"CCL3"</span>, <span class="st">"CXCR6"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">edger</span><span class="op">$</span><span class="va">color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span></span>
<span>        <span class="va">edger</span><span class="op">$</span><span class="va">FDR</span> <span class="op">&lt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="va">edger</span><span class="op">$</span><span class="va">logFC</span> <span class="op">&gt;</span> <span class="fl">0.5</span>, <span class="st">"#F8766D"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">edger</span><span class="op">$</span><span class="va">FDR</span> <span class="op">&lt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="va">edger</span><span class="op">$</span><span class="va">logFC</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span>, <span class="st">"#00BFC4"</span>, <span class="st">"grey"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with ggplot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">edger</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">logFC</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">FDR</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">edger</span><span class="op">$</span><span class="va">color</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html">geom_label_repel</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">edger</span>, <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">highlight</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">logFC</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">FDR</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">X</span><span class="op">)</span>, min.segment.length <span class="op">=</span> <span class="fl">0.1</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span>, color <span class="op">=</span> <span class="st">"grey20"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span>, color <span class="op">=</span> <span class="st">"grey20"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span></span>
<span>        yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span>, color <span class="op">=</span> <span class="st">"grey20"</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>        panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"NA"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="ie1-vs-ie2-boxplot" class="level3"><h3 class="anchored" data-anchor-id="ie1-vs-ie2-boxplot">IE1 vs IE2 BoxPlot</h3>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="va">Tcell_dir</span>, <span class="st">"sample_sum_counts.csv"</span><span class="op">)</span>,</span>
<span>    row.names <span class="op">=</span> <span class="st">"X"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###  setup data table ###</span></span>
<span><span class="va">rawdat</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Normalize counts by dividing through library size</span></span>
<span><span class="va">rawdat_cpm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">counts</span>,<span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">1000000</span><span class="op">)</span></span>
<span><span class="va">tdat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">rawdat_cpm</span><span class="op">)</span></span>
<span><span class="va">trnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">tdat</span><span class="op">)</span></span>
<span><span class="va">tdat</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">tdat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">tdat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span></span>
<span><span class="va">tdat</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">:=</span> <span class="va">trnames</span><span class="op">]</span></span>
<span><span class="va">TIG_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"IE1"</span>, <span class="st">"IE1"</span>, <span class="st">"IE1"</span>, <span class="st">"IE2"</span>, <span class="st">"IE2"</span>, <span class="st">"IE2"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">tdat</span><span class="op">[</span>, <span class="va">TIG</span> <span class="op">:=</span> <span class="va">TIG_list</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### format the tables</span></span>
<span><span class="va">dat</span> <span class="op">=</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt</a></span><span class="op">(</span></span>
<span>    <span class="va">tdat</span>, id.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'condition'</span>, <span class="st">'TIG'</span><span class="op">)</span>, variable.name<span class="op">=</span><span class="st">'gene'</span>, value.name <span class="op">=</span> <span class="st">'cpm'</span> , variable.factor <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># gene list</span></span>
<span><span class="va">GOI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"BATF"</span>, <span class="st">"IRF4"</span>, <span class="st">"CD55"</span>, <span class="st">"CD46"</span>,  <span class="st">"CSF1"</span>, <span class="st">"IL13"</span>, <span class="st">"CCL3"</span>, <span class="st">"CXCR6"</span>, </span>
<span>    <span class="st">"TCF7"</span>, <span class="st">"TOX"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">### plot together with edger values</span></span>
<span><span class="va">edger</span><span class="op">$</span><span class="va">gene</span> <span class="op">&lt;-</span> <span class="va">edger</span><span class="op">$</span><span class="va">X</span></span>
<span><span class="va">edger</span><span class="op">$</span><span class="va">FDR_x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'FDR = '</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="va">edger</span><span class="op">$</span><span class="va">FDR</span>, digits<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">edger</span><span class="op">$</span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'p = '</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="va">edger</span><span class="op">$</span><span class="va">PValue</span>, digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">gene</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">GOI</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span><span class="va">edger</span>, by<span class="op">=</span><span class="st">'gene'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">gene</span>,y<span class="op">=</span><span class="va">cpm</span>,color<span class="op">=</span><span class="va">TIG</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">gene</span><span class="op">+</span><span class="va">FDR_x</span><span class="op">+</span><span class="va">p</span>, scales <span class="op">=</span> <span class="st">"free"</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitterdodge.html">position_jitterdodge</a></span><span class="op">(</span>jitter.width <span class="op">=</span> <span class="fl">0</span>, jitter.height <span class="op">=</span> <span class="fl">0</span>, dodge.width <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html">expand_limits</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">0</span>,y<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.line.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>        axis.line.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>        panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        panel.border <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_rect</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, fill<span class="op">=</span><span class="st">"NA"</span><span class="op">)</span>,</span>
<span>        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        <span class="co">#strip.background = element_blank(),</span></span>
<span>        axis.ticks.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="sessioninfo" class="level2"><h2 class="anchored" data-anchor-id="sessioninfo">SessionInfo</h2>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center"><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2021-2024 Guorui Zhong ~ Made with <a href="https://www.r-project.org/"><i class="fa-brands fa-r-project" aria-label="r-project"></i></a> and <a href="https://quarto.org/">Quarto</a></span></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>